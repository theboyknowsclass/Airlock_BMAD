version: '3.8'

# Development configuration - overrides and additions ONLY
# Usage: docker-compose -f docker-compose.prod.yml -f docker-compose.dev.yml --env-file .env.dev up
# This file merges with docker-compose.prod.yml, adding/overriding development-specific settings only

services:
  # Override services for development with hot reload volumes and DEBUG logging
  # Only specify what's different from production
  
  api-gateway:
    volumes:
      - ./services/api-gateway/src:/app/src
    environment:
      LOG_LEVEL: DEBUG

  auth-service:
    volumes:
      - ./services/auth-service/src:/app/src
    ports:
      - "${AUTH_SERVICE_PORT:-8001}:8000"
    environment:
      LOG_LEVEL: DEBUG
      USE_MOCK_OAUTH: "true"
      MOCK_OAUTH_URL: "http://mock-oauth:9000"
      OAUTH2_CLIENT_ID: "airlock-client"
      OAUTH2_CLIENT_SECRET: ""
      OAUTH2_REDIRECT_URI: "http://localhost:8001/api/v1/auth/callback"
      FRONTEND_CALLBACK_URI: "http://localhost:3000/auth/callback"
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key-change-in-production-123456789012345678901234567890}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      JWT_ISSUER: "airlock-auth-service"
      ACCESS_TOKEN_EXPIRY_MINUTES: "15"
      REFRESH_TOKEN_EXPIRY_DAYS: "7"

  user-service:
    volumes:
      - ./services/user-service/src:/app/src
    environment:
      LOG_LEVEL: DEBUG

  api-key-service:
    volumes:
      - ./services/api-key-service/src:/app/src
    environment:
      LOG_LEVEL: DEBUG

  submission-service:
    volumes:
      - ./services/submission-service/src:/app/src
    environment:
      LOG_LEVEL: DEBUG

  workflow-service:
    volumes:
      - ./services/workflow-service/src:/app/src
    environment:
      LOG_LEVEL: DEBUG

  trivy-agent:
    volumes:
      - ./services/agents/trivy-agent/src:/app/src
    environment:
      LOG_LEVEL: DEBUG

  license-agent:
    volumes:
      - ./services/agents/license-agent/src:/app/src
    environment:
      LOG_LEVEL: DEBUG

  review-agent:
    volumes:
      - ./services/agents/review-agent/src:/app/src
    environment:
      LOG_LEVEL: DEBUG

  storage-service:
    volumes:
      - ./services/storage-service/src:/app/src
    environment:
      LOG_LEVEL: DEBUG

  registry-service:
    volumes:
      - ./services/registry-service/src:/app/src
    environment:
      LOG_LEVEL: DEBUG

  tracking-service:
    volumes:
      - ./services/tracking-service/src:/app/src
    environment:
      LOG_LEVEL: DEBUG

  frontend:
    volumes:
      - ./frontend/src:/app/src
      - /app/node_modules
    environment:
      VITE_API_BASE_URL: ${VITE_API_BASE_URL}

  # PostgreSQL - expose port for testing and local development
  postgres:
    ports:
      - "${POSTGRES_PORT:-5432}:5432"

  # RabbitMQ - expose ports for testing and local development
  rabbitmq:
    ports:
      - "5672:5672"  # AMQP port for client connections (always 5672)
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"  # Management UI port

  # Mock OAuth Service (development only - addition, not in prod)
  mock-oauth:
    build:
      context: ./mock-services/mock-oauth
      dockerfile: Dockerfile
    container_name: airlock-mock-oauth
    ports:
      - "${MOCK_OAUTH_PORT:-9000}:9000"
    environment:
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key-change-in-production-123456789012345678901234567890}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-airlock-mock-oauth}
      ACCESS_TOKEN_EXPIRY_MINUTES: ${ACCESS_TOKEN_EXPIRY_MINUTES:-15}
      REFRESH_TOKEN_EXPIRY_DAYS: ${REFRESH_TOKEN_EXPIRY_DAYS:-7}
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - airlock-network

  # pgAdmin (development only - addition, not in prod)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: airlock-pgadmin
    ports:
      - "${PGADMIN_PORT}:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - airlock-network

volumes:
  pgadmin_data:
