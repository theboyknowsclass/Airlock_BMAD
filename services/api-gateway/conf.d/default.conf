# Main server block
server {
    listen 80;
    server_name _;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # CORS headers (configure as needed)
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-API-Key" always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Max-Age 1728000 always;

    # Health check endpoint (no auth required)
    location /health {
        access_log off;
        default_type application/json;
        return 200 '{"status":"healthy","service":"api-gateway","timestamp":"$time_iso8601"}';
    }

    # Frontend static files
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Authentication endpoints (no JWT validation required)
    location ~ ^/api/v1/auth/(login|callback|token|refresh) {
        limit_req zone=auth_limit burst=5 nodelay;
        
        proxy_pass http://auth-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Forward API key header for API key authentication
        proxy_set_header X-API-Key $http_x_api_key;
    }

    # API Key Service endpoints (require JWT validation with admin role)
    location /api/v1/api-keys {
        limit_req zone=api_limit burst=20 nodelay;
        access_by_lua_file /usr/local/openresty/nginx/lua/validate_jwt_admin.lua;
        
        proxy_pass http://api-key-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API Key authentication endpoint (no JWT required, uses X-API-Key header)
    location ~ ^/api/v1/api-keys/auth/token {
        limit_req zone=auth_limit burst=5 nodelay;
        
        proxy_pass http://api-key-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key $http_x_api_key;
    }

    # User Service endpoints
    location /api/v1/users {
        limit_req zone=api_limit burst=20 nodelay;
        access_by_lua_file /usr/local/openresty/nginx/lua/validate_jwt.lua;
        
        proxy_pass http://user-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Package/Submission Service endpoints
    location /api/v1/packages {
        limit_req zone=api_limit burst=20 nodelay;
        access_by_lua_file /usr/local/openresty/nginx/lua/validate_jwt.lua;
        
        proxy_pass http://submission-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Workflow Service endpoints
    location /api/v1/workflows {
        limit_req zone=api_limit burst=20 nodelay;
        access_by_lua_file /usr/local/openresty/nginx/lua/validate_jwt.lua;
        
        proxy_pass http://workflow-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Storage Service endpoints
    location /api/v1/storage {
        limit_req zone=api_limit burst=20 nodelay;
        access_by_lua_file /usr/local/openresty/nginx/lua/validate_jwt.lua;
        
        proxy_pass http://storage-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Registry Service endpoints
    location /api/v1/registry {
        limit_req zone=api_limit burst=20 nodelay;
        access_by_lua_file /usr/local/openresty/nginx/lua/validate_jwt.lua;
        
        proxy_pass http://registry-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Tracking Service endpoints
    location /api/v1/tracking {
        limit_req zone=api_limit burst=20 nodelay;
        access_by_lua_file /usr/local/openresty/nginx/lua/validate_jwt.lua;
        
        proxy_pass http://tracking-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Error pages
    error_page 401 /401.json;
    error_page 403 /403.json;
    error_page 429 /429.json;
    error_page 500 502 503 504 /50x.json;

    location = /401.json {
        internal;
        default_type application/json;
        return 200 '{"error":{"code":"UNAUTHORIZED","message":"Authentication required"}}';
    }

    location = /403.json {
        internal;
        default_type application/json;
        return 200 '{"error":{"code":"FORBIDDEN","message":"Insufficient permissions"}}';
    }

    location = /429.json {
        internal;
        default_type application/json;
        return 200 '{"error":{"code":"RATE_LIMIT_EXCEEDED","message":"Too many requests"}}';
    }

    location = /50x.json {
        internal;
        default_type application/json;
        return 200 '{"error":{"code":"INTERNAL_SERVER_ERROR","message":"Service temporarily unavailable"}}';
    }
}

